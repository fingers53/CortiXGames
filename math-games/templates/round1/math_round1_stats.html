<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CortiX Games</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/auth.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/math-games/static/css/round1/math-rounds.css">
</head>
<body>
    <div class="auth-bar">
        <a href="/" class="home-link" aria-label="Home">üè†</a>
        <div class="auth-status">
            {% if current_user %}
            <span class="status-pill">Logged in</span>
            <span class="status-name">{{ current_user.username }}</span>
            {% else %}
            <span class="status-pill guest">Guest</span>
            <span class="status-name">Not signed in</span>
            {% endif %}
        </div>
    </div>

    <div class="math-rounds-container">
        <header class="math-rounds-header">
            <div>
                <h1>Round 1 Stats</h1>
                <p class="subtitle">Score distribution and difficulty snapshot</p>
            </div>
            <div class="actions">
                <a class="link" href="/math-game">Play</a>
                <a class="link" href="/math-game/leaderboard">Leaderboard</a>
            </div>
        </header>

        <section class="panel">
            <h2>Score distribution</h2>
            <div id="histogram" class="histogram"></div>
        </section>

        <section class="panel">
            <h2>Difficulty snapshot</h2>
            <p class="muted" id="difficulty-note">Loading question difficulty‚Ä¶</p>
            <div class="difficulty-grid" id="difficulty-grid"></div>
        </section>

        <section class="panel">
            <h2>Performance by profile attributes</h2>
            <p class="muted">Average correct answers (per run) and reaction speed grouped by age band, sex, and handedness.</p>
            <div class="attribute-grid" id="attribute-panels"></div>
        </section>
    </div>

    <script>
        function renderHistogram(buckets) {
            const container = document.getElementById('histogram');
            container.innerHTML = '';
            if (!buckets.length) {
                container.textContent = 'No runs yet. Play a round to populate the stats!';
                return;
            }
            const maxCount = Math.max(...buckets.map(b => b.count));
            buckets.forEach((b) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                const height = maxCount ? (b.count / maxCount) * 100 : 0;
                bar.style.height = `${height}%`;
                bar.title = `${b.min}-${b.max}: ${b.count}`;
                const label = document.createElement('span');
                label.textContent = `${b.min}-${b.max}`;
                bar.appendChild(label);
                container.appendChild(bar);
            });
        }

        function renderDifficulty(summary) {
            const grid = document.getElementById('difficulty-grid');
            const note = document.getElementById('difficulty-note');
            grid.innerHTML = '';
            const hardest = summary.hardest_questions || [];
            const easiest = summary.easiest_questions || [];
            if (!hardest.length && !easiest.length) {
                note.textContent = 'Difficulty modeling coming soon ‚Äî data will appear here once implemented.';
                return;
            }
            note.textContent = '';
            const renderSection = (title, list) => {
                const section = document.createElement('div');
                section.className = 'difficulty-section';
                const heading = document.createElement('h3');
                heading.textContent = title;
                section.appendChild(heading);
                if (!list.length) {
                    const p = document.createElement('p');
                    p.textContent = 'No data yet.';
                    section.appendChild(p);
                } else {
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead><tr><th>Expression</th><th>Avg time (s)</th><th>Avg wrong</th><th>Samples</th></tr></thead>
                        <tbody></tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    list.forEach((item) => {
                        const expr = `${item.a} ${item.operator} ${item.b}`;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${expr}</td>
                            <td>${((item.avg_time_ms || 0) / 1000).toFixed(2)}</td>
                            <td>${(item.avg_wrong_attempts || 0).toFixed(2)}</td>
                            <td>${item.samples || 0}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    section.appendChild(table);
                }
                grid.appendChild(section);
            };
            renderSection('Hardest', hardest);
            renderSection('Easiest', easiest);
        }

        function formatMetric(value, suffix = '') {
            if (value === null || value === undefined || Number.isNaN(value)) return '‚Äî';
            return `${Number(value).toFixed(1)}${suffix}`;
        }

        function renderAttributeBreakdown(dataset) {
            const container = document.getElementById('attribute-panels');
            if (!container) return;
            container.innerHTML = '';
            if (!dataset) {
                container.textContent = 'No attribute data available yet.';
                return;
            }

            const attributeLabels = {
                age_band: 'Age band',
                sex: 'Sex',
                handedness: 'Handedness',
            };

            Object.entries(attributeLabels).forEach(([key, label]) => {
                const data = dataset[key];
                if (!data) return;
                const card = document.createElement('div');
                card.className = 'panel attribute-card';

                const rowsByLabel = new Map();
                const addValues = (list, field, sampleField, averageField) => {
                    (list || []).forEach((entry) => {
                        const row = rowsByLabel.get(entry.label) || { label: entry.label };
                        row[field] = entry[averageField];
                        row[sampleField] = entry.samples;
                        rowsByLabel.set(entry.label, row);
                    });
                };

                addValues(data.math_round1, 'round1', 'round1_samples', 'avg_correct');
                addValues(data.math_round2, 'round2', 'round2_samples', 'avg_correct');
                addValues(data.math_round3, 'round3', 'round3_samples', 'avg_correct');
                addValues(data.reaction, 'reaction_ms', 'reaction_samples', 'avg_reaction_ms');

                const labelsList = Array.from(rowsByLabel.values()).sort((a, b) => {
                    if (!a.label) return -1;
                    if (!b.label) return 1;
                    return a.label.localeCompare(b.label);
                });

                card.innerHTML = `
                    <h3>${label}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Group</th>
                                <th>Round 1 avg correct</th>
                                <th>Round 2 avg correct</th>
                                <th>Round 3 avg correct</th>
                                <th>Avg reaction (ms)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;

                const tbody = card.querySelector('tbody');
                labelsList.forEach((entry) => {
                    const round1 = entry.round1 !== undefined
                        ? `${formatMetric(entry.round1)} (n=${entry.round1_samples || 0})`
                        : '‚Äî';
                    const round2 = entry.round2 !== undefined
                        ? `${formatMetric(entry.round2)} (n=${entry.round2_samples || 0})`
                        : '‚Äî';
                    const round3 = entry.round3 !== undefined
                        ? `${formatMetric(entry.round3)} (n=${entry.round3_samples || 0})`
                        : '‚Äî';
                    const reaction = entry.reaction_ms !== undefined
                        ? `${formatMetric(entry.reaction_ms)} (n=${entry.reaction_samples || 0})`
                        : '‚Äî';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${entry.label || 'Unknown'}</td>
                        <td>${round1}</td>
                        <td>${round2}</td>
                        <td>${round3}</td>
                        <td>${reaction}</td>
                    `;
                    tbody.appendChild(tr);
                });

                container.appendChild(card);
            });
        }

        fetch('/api/math-game/yetamax/score-distribution')
            .then((resp) => resp.json())
            .then((data) => renderHistogram(data.buckets || []))
            .catch(() => {
                const container = document.getElementById('histogram');
                container.textContent = 'Could not load score distribution.';
            });

        fetch('/api/math-game/yetamax/difficulty-summary')
            .then((resp) => resp.json())
            .then((data) => renderDifficulty(data))
            .catch(() => {
                const note = document.getElementById('difficulty-note');
                note.textContent = 'Could not load difficulty data.';
            });

        fetch('/api/stats/profile-breakdown')
            .then((resp) => resp.json())
            .then((data) => renderAttributeBreakdown(data))
            .catch((err) => {
                console.error('Failed to load attribute breakdown', err);
                const container = document.getElementById('attribute-panels');
                container.textContent = 'Unable to load attribute breakdown.';
            });
    </script>
</body>
</html>
